# STM32-Based 4WD Smart Robot Car

Author：zyp、gay、zby

这是一个基于STM32F407VET6微控制器和Raspberry Pi 4B上位机的四轮驱动智能小车项目。它集成了多种功能，包括基于PID算法的闭环电机速度控制、四路红外循迹、超声波避障以及通过I2C通信的语音识别控制。



## ✨ 主要功能



- **高级运动控制**:
  - 采用四轮差速驱动模型。
  - 为每个电机配备编码器，通过PID算法实现精确的速度闭环控制，确保小车稳定行驶。
- **智能循迹**:
  - 使用四路红外传感器阵列检测黑线。
  - 通过PID控制器计算偏移量，实现平滑、精准的循迹运动。
- **超声波避障**:
  - 集成HC-SR04超声波模块，实时检测前方障碍物。
  - 当距离小于设定阈值时，小车会自动停止或执行避障策略。
- **语音识别控制**:
  - 集成ASR（自动语音识别）模块，通过I2C协议进行通信。
  - 支持“前进”、“后退”、“左转”、“右转”、“停止”等自定义语音指令，实现人车交互。



## 🛠️ 硬件架构



本项目的硬件核心是STM32微控制器，负责所有实时控制任务。语音识别由一个专门的模块处理，并通过Python脚本进行上层逻辑交互（运行在Raspberry Pi 4B上位机上）。

- **主控制器**: STM32F407VET6 开发板
- **底盘**: 4WD 差速驱动底盘
- **电机**: 4 x 直流减速电机 (带霍尔编码器)
- **电机驱动**: 2 x L298N 双路H桥驱动模块
- **传感器**:
  - **循迹**: 4通道红外反射式循迹模块
  - **避障**: HC-SR04 超声波测距模块
  - **语音**: ASR 语音识别模块 (I2C接口)
- **电源**: 7.4V 锂电池组及相应的降压稳压模块



## 📂 软件与代码结构





#### 固件 (STM32)



基于STM32 HAL库进行开发，推荐使用STM32CubeIDE。

- `Core/`: 存放 `main.c` 和其他核心应用代码。
  - `main.c`: 主循环，负责任务调度和模式切换。
  - `stm32f4xx_it.c`: 中断服务函数定义。
- `Drivers/`: 存放HAL库驱动和CMSIS核心文件。
- **应用层代码 (示例)**:
  - `motor_porting.c/.h`: 电机和编码器的硬件接口适配层，包括PWM和定时器配置。
  - `encoder_motor.c/.h`: 电机PID控制的硬件无关逻辑实现。
  - `differential_chassis.c/.h`: 差速底盘运动学模型。
  - `line_follower.c/.h`: 循迹功能的PID算法实现。



#### 上位机 (Python)



用于与ASR语音模块交互，并将识别结果通过串口等方式发送给STM32。

- `speech_recognition.py`:
  - 使用 `smbus` 库通过I2C总线读取ASR模块的识别结果。
  - 将识别出的指令ID（例如，1代表“前进”）进行解析。
  - (可扩展) 通过串口 (`pyserial`) 将具体指令发送给STM32。



## 🚀 如何开始





#### 1. 编译与烧录固件



1. **准备环境**: 安装 [STM32CubeIDE](https://www.st.com/en/development-tools/stm32cubeide.html) 和 ST-LINK 驱动。

2. **克隆仓库**:

   Bash

   ```
   git clone https://github.com/YourUsername/STM32-Smart-Robot-Car.git
   ```

3. **打开工程**: 在STM32CubeIDE中，选择 `File -> Open Projects from File System...`，然后选择本项目的根目录。

4. **编译**: 点击工具栏上的锤子图标 (Build) 来编译工程。

5. **烧录**: 使用ST-LINK连接开发板，点击绿色的播放按钮 (Run) 来烧录程序。



#### 2. 配置上位机 (如果使用)



1. 确保您的上位机（如Raspberry Pi）已启用I2C功能。

2. 安装Python依赖库：

   Bash

   ```
   pip install smbus
   ```

3. 运行语音识别脚本：

   Bash

   ```
   sudo python3 speech_recognition.py
   ```



## ⚙️ 功能详解





#### 循迹 PID 逻辑



循迹功能通过读取4个传感器的状态来计算小车与黑线的偏移 `error`。

| S1   | S2   | S3   | S4   | 状态描述         | Error值 | 调整方向 |
| ---- | ---- | ---- | ---- | ---------------- | ------- | -------- |
| 0    | 1    | 0    | 0    | 稍微偏右         | -1      | 向左微调 |
| 1    | 1    | 0    | 0    | 偏右较多         | -2      | 向左中调 |
| 1    | 0    | 0    | 0    | 严重偏右         | -6      | 向左大调 |
| 0    | 0    | 1    | 0    | 稍微偏左         | 1       | 向右微调 |
| 0    | 0    | 1    | 1    | 偏左较多         | 2       | 向右中调 |
| 0    | 0    | 0    | 1    | 严重偏左         | 6       | 向右大调 |
| 0    | 0    | 0    | 0    | 居中或未检测到线 | 0       | 保持直行 |

Export to Sheets

`line_folower` 函数返回一个PID计算后的角速度值，可直接用于 `diff_chassis_move` 函数来控制小车转向。



#### 语音指令



语音模块将识别到的词条转换为一个ID值，Python脚本读取此ID并打印对应的指令。

- `ID 1`: "go" (前进)
- `ID 2`: "back" (后退)
- `ID 3`: "left" (左转)
- `ID 4`: "right" (右转)
- `ID 9`: "stop" (停止)



## 展望



- 实现一个状态机来优雅地切换循迹、避障和语音控制模式。
- 添加蓝牙或Wi-Fi模块，实现手机APP遥控。
- 尝试使用FreeRTOS操作系统来管理多任务。
- 引入摄像头和OpenMV/Raspberry Pi，实现更高级的视觉循迹或物体识别。



## 📜 许可证



本项目采用 [MIT License](https://www.google.com/search?q=LICENSE) 开源。
